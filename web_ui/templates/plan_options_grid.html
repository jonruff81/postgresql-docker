{% extends "base.html" %}

{% block title %}Plan Options - Simonini Grid{% endblock %}

{% block page_title %}üèóÔ∏è Plan Options Management{% endblock %}

{% block toolbar_right %}
    <a href="/" class="btn" style="background: #6c757d; margin-right: 15px;">üè† Dashboard</a>
    <button type="button" class="btn" onclick="saveChanges()">üíæ Save Changes</button>
    <button type="button" class="btn" onclick="addNewRow()">‚ûï Add New</button>
    <button type="button" class="btn" onclick="refreshGrid()">üîÑ Refresh</button>
    <div class="btn-group" style="margin-left: 10px;">
        <button type="button" class="btn dropdown-toggle" data-bs-toggle="dropdown">üìä Export</button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="exportToExcel()">üìà Export Excel</a></li>
            <li><a class="dropdown-item" href="#" onclick="exportToCsv()">üìä Export CSV</a></li>
        </ul>
    </div>
    <div class="btn-group">
        <button type="button" class="btn dropdown-toggle" data-bs-toggle="dropdown">üì• Import</button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="downloadTemplate('excel')">üìã Download Excel Template</a></li>
            <li><a class="dropdown-item" href="#" onclick="downloadTemplate('csv')">üìã Download CSV Template</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#" onclick="triggerImport()">üì• Import File</a></li>
        </ul>
    </div>
{% endblock %}

{% block head %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        }
        .btn-group .btn {
            margin-left: 0;
        }
        .dropdown-menu {
            background: var(--white);
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .dropdown-item {
            color: var(--text);
            padding: 8px 16px;
        }
        .dropdown-item:hover {
            background: var(--offwhite);
            color: var(--navy);
        }
        .grid-info {
            background: var(--white);
            padding: 16px 32px;
            margin: 0 auto 2rem auto;
            max-width: 1400px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(24,38,65,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: #666;
        }
        #fileInput {
            display: none;
        }
    </style>
{% endblock %}

{% block grid %}
    <div id="statusMessage" class="status-message"></div>
    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" onchange="handleFileImport(event)">
    <div style="max-width: 1400px; margin: 0 auto 1rem auto; display: flex; align-items: center;">
        <input id="globalFilterInput" type="text" class="form-control" style="max-width: 350px; margin-right: 1rem;" placeholder="üîé Filter any column..." oninput="onGlobalFilterChanged()">
        <span style="color: #888; font-size: 13px;">Type to filter all columns</span>
    </div>
    <div class="grid-info">
        <div>
            <span id="rowCount">0</span> records | 
            <span id="selectedCount">0</span> selected |
            <span id="filteredCount">0</span> filtered
        </div>
        <div>
            Double-click to edit | Right-click for context menu | Ctrl+S to save
        </div>
    </div>
    <div id="planOptionsGrid" class="ag-theme-alpine" style="height: 650px; width: 100%;"></div>
{% endblock %}

{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-enterprise@30.2.0/dist/ag-grid-enterprise.min.js"></script>
    <script>
        // AG-Grid License Key from Flask config
        const AG_GRID_LICENSE_KEY = '{{ config.AG_GRID_LICENSE_KEY }}';
        if (AG_GRID_LICENSE_KEY && AG_GRID_LICENSE_KEY.length > 50) {
            agGrid.LicenseManager.setLicenseKey(AG_GRID_LICENSE_KEY);
        }

        let gridApi;
        let modifiedRows = [];

        // Column definitions for plan_options (all fields)
        const columnDefs = [
            {
                headerName: "Actions",
                field: "actions",
                width: 220,
                pinned: 'left',
                lockPosition: true,
                cellRenderer: function(params) {
                    // Use DOM API to ensure both buttons render
                    const container = document.createElement('span');
                    container.style.display = 'inline-flex';
                    container.style.alignItems = 'center';
                    container.style.background = '#ffe8a2';
                    container.style.border = '1px solid #dc3545';

                    const dupBtn = document.createElement('button');
                    dupBtn.className = 'btn btn-sm btn-outline-secondary me-1';
                    dupBtn.textContent = 'Duplicate';
                    dupBtn.onclick = function(e) {
                        e.stopPropagation();
                        openDuplicatePlanOptionModal(params.data.plan_option_id);
                    };

                    const delBtn = document.createElement('button');
                    delBtn.className = 'btn btn-sm btn-outline-danger';
                    delBtn.textContent = 'Delete';
                    delBtn.onclick = function(e) {
                        e.stopPropagation();
                        deletePlanOption(params.data.plan_option_id);
                    };

                    container.appendChild(dupBtn);
                    container.appendChild(delBtn);
                    return container;
                },
                sortable: false,
                filter: false,
                resizable: false,
                suppressMenu: true
            },
            { headerName: "", checkboxSelection: true, headerCheckboxSelection: true, width: 40, pinned: 'left', suppressMenu: true, suppressMovable: true },
            { headerName: "Plan Option ID", field: "plan_option_id", width: 100, editable: false, pinned: 'left' },
            { headerName: "Plan Elevation ID", field: "plan_elevation_id", width: 120, editable: true },
            { headerName: "Plan Name", field: "plan_full_name", width: 180, editable: false },
            { headerName: "Option Name", field: "option_name", width: 140, editable: true },
            { headerName: "Option Type", field: "option_type", width: 120, editable: true },
            { headerName: "Description", field: "option_description", width: 220, editable: true },
            { headerName: "Bedroom Count", field: "bedroom_count", width: 120, editable: true, type: 'numericColumn' },
            { headerName: "Bathroom Count", field: "bathroom_count", width: 120, editable: true, type: 'numericColumn' },
            { headerName: "Heated SF Inside Studs", field: "heated_sf_inside_studs", width: 160, editable: true, type: 'numericColumn' },
            { headerName: "Heated SF Outside Studs", field: "heated_sf_outside_studs", width: 160, editable: true, type: 'numericColumn' },
            { headerName: "Heated SF Outside Veneer", field: "heated_sf_outside_veneer", width: 180, editable: true, type: 'numericColumn' },
            { headerName: "Unheated SF Inside Studs", field: "unheated_sf_inside_studs", width: 180, editable: true, type: 'numericColumn' },
            { headerName: "Unheated SF Outside Studs", field: "unheated_sf_outside_studs", width: 180, editable: true, type: 'numericColumn' },
            { headerName: "Unheated SF Outside Veneer", field: "unheated_sf_outside_veneer", width: 200, editable: true, type: 'numericColumn' },
            { headerName: "Total SF Inside Studs", field: "total_sf_inside_studs", width: 160, editable: true, type: 'numericColumn' },
            { headerName: "Total SF Outside Studs", field: "total_sf_outside_studs", width: 160, editable: true, type: 'numericColumn' },
            { headerName: "Total SF Outside Veneer", field: "total_sf_outside_veneer", width: 180, editable: true, type: 'numericColumn' },
            { headerName: "Created Date", field: "created_date", width: 140, editable: false },
            { headerName: "Modified Date", field: "modified_date", width: 140, editable: false }
        ];

        const gridOptions = {
            columnDefs: columnDefs,
            defaultColDef: {
                sortable: true,
                filter: true,
                resizable: true,
                editable: false,
                cellEditor: 'agTextCellEditor',
                enableRowGroup: true,
                enablePivot: true,
                enableValue: true,
                suppressMenu: false,
                filterParams: {
                    buttons: ['reset', 'apply'],
                    miniFilter: true,
                    applyMiniFilterWhileTyping: true,
                }
            },
            enableRangeSelection: true,
            enableFillHandle: true,
            enableCellChangeFlash: true,
            rowSelection: 'multiple',
            rowMultiSelectWithClick: true,
            suppressRowClickSelection: false,
            enableCellTextSelection: true,
            ensureDomOrder: true,
            pagination: true,
            paginationPageSize: 100,
            paginationAutoPageSize: false,
            stopEditingWhenCellsLoseFocus: true,
            singleClickEdit: false,
            sideBar: {
                toolPanels: [
                    {
                        id: 'columns',
                        labelDefault: 'Columns',
                        labelKey: 'columns',
                        iconKey: 'columns',
                        toolPanel: 'agColumnsToolPanel'
                    },
                    {
                        id: 'filters',
                        labelDefault: 'Filters',
                        labelKey: 'filters',
                        iconKey: 'filter',
                        toolPanel: 'agFiltersToolPanel'
                    }
                ],
                defaultToolPanel: 'columns',
                hiddenByDefault: false
            },
            suppressHorizontalScroll: false,
            domLayout: 'normal',
            rowGroupPanelShow: 'always',
            pivotPanelShow: 'always',
            statusBar: {
                statusPanels: [
                    { statusPanel: 'agTotalAndFilteredRowCountComponent' },
                    { statusPanel: 'agSelectedRowCountComponent' },
                    { statusPanel: 'agAggregationComponent' }
                ]
            },
            onGridReady: onGridReady,
            onCellValueChanged: onCellValueChanged,
            onFilterChanged: updateRowCount,
            onSelectionChanged: updateRowCount,
            getContextMenuItems: getContextMenuItems,
            getRowStyle: function(params) {
                if (modifiedRows.includes(params.node.id)) {
                    return { backgroundColor: '#ffe8a2' };
                }
                return null;
            }
        };

        function onGridReady(params) {
            gridApi = params.api;
            loadData();
        }

        function loadData() {
            fetch('/api/plan-options')
                .then(response => response.json())
                .then(data => {
                    gridApi.setRowData(data);
                    updateRowCount();
                });
        }

        function onCellValueChanged(event) {
            const rowId = event.node.id;
            if (!modifiedRows.includes(rowId)) {
                modifiedRows.push(rowId);
            }
            gridApi.refreshRows({ rowNodes: [event.node] });
            showStatus('Row modified. Click "Save Changes" to update database.', 'warning');
        }

        function updateRowCount() {
            if (!gridApi) return;
            const totalRows = gridApi.getDisplayedRowCount();
            const selectedRows = gridApi.getSelectedRows().length;
            const filteredRows = totalRows;
            document.getElementById('rowCount').textContent = totalRows;
            document.getElementById('selectedCount').textContent = selectedRows;
            document.getElementById('filteredCount').textContent = filteredRows;
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            const alertClass = {
                'success': 'alert-success',
                'error': 'alert-danger',
                'warning': 'alert-warning',
                'info': 'alert-info'
            }[type] || 'alert-info';
            statusDiv.innerHTML = `<div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    const alert = statusDiv.querySelector('.alert');
                    if (alert) {
                        const bsAlert = new bootstrap.Alert(alert);
                        bsAlert.close();
                    }
                }, 5000);
            }
        }

        function onGlobalFilterChanged() {
            const filterValue = document.getElementById('globalFilterInput').value;
            if (gridApi) {
                gridApi.setQuickFilter(filterValue);
                updateRowCount();
            }
        }

        function getContextMenuItems(params) {
            return [
                'copy',
                'paste',
                'separator',
                'export'
            ];
        }

        function saveChanges() {
            if (modifiedRows.length === 0) {
                showStatus('No changes to save', 'info');
                return;
            }
            const updates = [];
            modifiedRows.forEach(rowId => {
                const node = gridApi.getRowNode(rowId);
                if (node) {
                    updates.push(node.data);
                }
            });
            fetch('/api/plan-options/bulk-update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ updates: updates })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    modifiedRows = [];
                    loadData();
                    showStatus(`Successfully updated ${updates.length} records`, 'success');
                } else {
                    showStatus('Error saving changes: ' + result.message, 'error');
                }
            })
            .catch(error => {
                showStatus('Error saving changes: ' + error.message, 'error');
            });
        }

        function addNewRow() {
            const newRow = {
                plan_option_id: null,
                plan_full_name: '',
                option_name: '',
                option_description: '',
                total_sf_outside_studs: '',
                created_date: '',
                modified_date: ''
            };
            gridApi.applyTransaction({ add: [newRow], addIndex: 0 });
            setTimeout(() => {
                const firstNode = gridApi.getDisplayedRowAtIndex(0);
                if (firstNode) {
                    gridApi.startEditingCell({
                        rowIndex: 0,
                        colKey: 'plan_full_name'
                    });
                    modifiedRows.push(firstNode.id);
                }
            }, 100);
            showStatus('New row added. Fill in the details and save.', 'info');
        }

        function refreshGrid() {
            modifiedRows = [];
            loadData();
        }

        function exportToExcel() {
            window.location.href = '/api/plan-options/export/excel';
            showStatus('Excel export started', 'success');
        }

        function exportToCsv() {
            window.location.href = '/api/plan-options/export/csv';
            showStatus('CSV export started', 'success');
        }

        function downloadTemplate(format) {
            window.location.href = `/api/plan-options/template/${format}`;
            showStatus(`${format.toUpperCase()} template download started`, 'success');
        }

        function triggerImport() {
            document.getElementById('fileInput').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append('file', file);
            showStatus('Importing file...', 'info');
            fetch('/api/plan-options/import', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showStatus(result.message, 'success');
                    refreshGrid();
                } else {
                    showStatus('Import failed: ' + result.message, 'error');
                }
            })
            .catch(error => {
                showStatus('Error importing file: ' + error.message, 'error');
            });
            event.target.value = '';
        }

        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        saveChanges();
                        break;
                    case 'n':
                        e.preventDefault();
                        addNewRow();
                        break;
                    case 'r':
                        e.preventDefault();
                        refreshGrid();
                        break;
                }
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            const gridDiv = document.getElementById('planOptionsGrid');
            new agGrid.Grid(gridDiv, gridOptions);
        });
        // --- Duplicate & Delete Plan Option Logic ---
        let duplicatePlanOptionData = null;

        function openDuplicatePlanOptionModal(planOptionId) {
            if (!gridApi) return;
            const node = gridApi.getRowNode(planOptionId);
            if (!node || !node.data) {
                showStatus('Could not find plan option to duplicate.', 'error');
                return;
            }
            duplicatePlanOptionData = { ...node.data };
            // Fill modal fields
            document.getElementById('dup_plan_option_id').value = duplicatePlanOptionData.plan_option_id || '';
            document.getElementById('dup_plan_full_name').value = duplicatePlanOptionData.plan_full_name || '';
            document.getElementById('dup_option_name').value = duplicatePlanOptionData.option_name || '';
            document.getElementById('dup_option_type').value = duplicatePlanOptionData.option_type || '';
            document.getElementById('dup_option_description').value = duplicatePlanOptionData.option_description || '';
            document.getElementById('dup_bedroom_count').value = duplicatePlanOptionData.bedroom_count || '';
            document.getElementById('dup_bathroom_count').value = duplicatePlanOptionData.bathroom_count || '';
            document.getElementById('dup_total_sf_outside_studs').value = duplicatePlanOptionData.total_sf_outside_studs || '';
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('duplicatePlanOptionModal'));
            modal.show();
        }

        async function saveDuplicatePlanOption() {
            let data = {};
            try {
                data = {
                    plan_full_name: document.getElementById('dup_plan_full_name').value.trim(),
                    option_name: document.getElementById('dup_option_name').value.trim(),
                    option_type: document.getElementById('dup_option_type').value.trim(),
                    option_description: document.getElementById('dup_option_description').value.trim(),
                    bedroom_count: document.getElementById('dup_bedroom_count').value.trim(),
                    bathroom_count: document.getElementById('dup_bathroom_count').value.trim(),
                    total_sf_outside_studs: document.getElementById('dup_total_sf_outside_studs').value.trim()
                };
                if (!data.plan_full_name || !data.option_name) {
                    showStatus('Plan name and option name are required.', 'error');
                    return;
                }
            } catch (err) {
                showStatus('Error preparing data: ' + err.message, 'error');
                return;
            }
            try {
                const planOptionId = duplicatePlanOptionData.plan_option_id;
                const response = await fetch(`/api/plan-options/${planOptionId}/duplicate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (!response.ok || !result.success) {
                    showStatus('Failed to duplicate: ' + (result.message || response.statusText), 'error');
                    return;
                }
                // Hide modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('duplicatePlanOptionModal'));
                if (modal) modal.hide();
                // Refresh grid
                refreshGrid();
                showStatus('Plan option duplicated successfully!', 'success');
            } catch (error) {
                showStatus('Failed to duplicate: ' + error.message, 'error');
            }
        }

        async function deletePlanOption(planOptionId) {
            if (!confirm('Are you sure you want to delete this plan option?')) return;
            try {
                const response = await fetch(`/api/plan-options/${planOptionId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (!response.ok || !result.success) {
                    showStatus('Failed to delete: ' + (result.message || response.statusText), 'error');
                    return;
                }
                refreshGrid();
                showStatus('Plan option deleted successfully', 'success');
            } catch (error) {
                showStatus('Failed to delete: ' + error.message, 'error');
            }
        }
    </script>

    <!-- Duplicate Plan Option Modal -->
    <div class="modal fade" id="duplicatePlanOptionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Duplicate Plan Option</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="duplicatePlanOptionForm">
                        <div class="mb-3">
                            <label class="form-label">Plan Option ID (original)</label>
                            <input type="text" class="form-control" id="dup_plan_option_id" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Plan Name *</label>
                            <input type="text" class="form-control" id="dup_plan_full_name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Option Name *</label>
                            <input type="text" class="form-control" id="dup_option_name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Option Type</label>
                            <input type="text" class="form-control" id="dup_option_type">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <input type="text" class="form-control" id="dup_option_description">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Bedroom Count</label>
                            <input type="number" class="form-control" id="dup_bedroom_count">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Bathroom Count</label>
                            <input type="number" class="form-control" id="dup_bathroom_count">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Total SF Outside Studs</label>
                            <input type="number" class="form-control" id="dup_total_sf_outside_studs">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveDuplicatePlanOption()">Save Duplicate</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
