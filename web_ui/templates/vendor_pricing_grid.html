{% extends "base.html" %}
{% block title %}Vendor Pricing Grid{% endblock %}
{% block page_title %}üí∞ Vendor Pricing Grid{% endblock %}

{% block toolbar_right %}
<a href="/" class="btn btn-outline-secondary">‚Üê Back to Dashboard</a>
<button type="button" class="btn btn-warning" onclick="refreshGrid()">üîÑ Refresh</button>
<button type="button" class="btn btn-info" onclick="exportToCsv()">üìä Export CSV</button>
<button type="button" class="btn btn-success" onclick="exportToExcel()">üìà Export Excel</button>
<button type="button" class="btn btn-outline-primary" onclick="showBulkImportModal()">üì• Bulk Import</button>
<button type="button" class="btn btn-outline-info" onclick="showQuickStats()">üìä Quick Stats</button>
<button type="button" class="btn btn-outline-success" onclick="downloadTemplate('csv')">‚¨áÔ∏è Download Template (CSV)</button>
<button type="button" class="btn btn-outline-success" onclick="downloadTemplate('excel')">‚¨áÔ∏è Download Template (Excel)</button>
<button type="button" class="btn btn-outline-success" onclick="addRow()">‚ûï Add Row</button>
<button type="button" class="btn btn-outline-secondary" onclick="showDuplicateModal()">‚ßâ Duplicate Row</button>
<button type="button" class="btn btn-outline-danger" onclick="deleteRow()">üóëÔ∏è Delete Row</button>
{% endblock %}

{% block grid %}
<div id="statusMessage" class="status-message"></div>
<div id="vendorPricingGrid" style="height: 80vh; width: 100%;"></div>
{% endblock %}

{% block scripts %}
<!-- Bootstrap JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    agGrid.LicenseManager.setLicenseKey("{{ ag_grid_license_key|e }}");

    let gridApi;
    let gridColumnApi;
    let allData = [];
    let productDescMap = {};

    // Fetch product options by item name (with product_id)
    let productDescPromise = fetch('/api/products-by-item-name')
        .then(res => res.json())
        .then(data => { productDescMap = data || {}; });

    // Custom cell editor for Product Description dropdown (shows description, stores product_id)
    function ProductDescriptionEditor() {}
    ProductDescriptionEditor.prototype.init = function(params) {
        this.params = params;
        this.eInput = document.createElement('select');
        this.eInput.className = 'form-select form-select-sm';
        const itemName = params.data.item_name;
        const options = (itemName && productDescMap[itemName]) ? productDescMap[itemName] : [];
        const blank = document.createElement('option');
        blank.value = '';
        blank.text = '';
        this.eInput.appendChild(blank);
        options.forEach(optObj => {
            const opt = document.createElement('option');
            opt.value = optObj.product_id;
            opt.text = optObj.product_description;
            if (optObj.product_id == params.data.product_id) opt.selected = true;
            this.eInput.appendChild(opt);
        });
        this.eInput.value = params.data.product_id || '';
        this.eInput.focus();
    };
    ProductDescriptionEditor.prototype.getGui = function() { return this.eInput; };
    ProductDescriptionEditor.prototype.afterGuiAttached = function() { this.eInput.focus(); };
    ProductDescriptionEditor.prototype.getValue = function() {
        // Return just the product_description string for AG-Grid cell value
        const selectedId = this.eInput.value;
        const itemName = this.params.data.item_name;
        const options = (itemName && productDescMap[itemName]) ? productDescMap[itemName] : [];
        const found = options.find(opt => String(opt.product_id) === String(selectedId));
        // Also update the row data with product_id for backend update
        if (this.params.data) {
            this.params.data.product_id = selectedId;
        }
        return found ? found.product_description : '';
    };
    ProductDescriptionEditor.prototype.destroy = function() {};
    ProductDescriptionEditor.prototype.isPopup = function() { return false; };

    const columnDefs = [
        {
            headerName: 'Actions',
            field: 'actions',
            width: 180,
            pinned: 'left',
            lockPosition: true,
            cellRenderer: params => {
                const pricingId = params.data?.pricing_id;
                console.log('cellRenderer - pricing_id:', pricingId, 'data:', params.data);
                
                // Ensure we have a valid pricing_id
                if (!pricingId && pricingId !== 0) {
                    return '<span class="text-muted">No Actions</span>';
                }
                
                // Use string HTML with data attributes for event delegation
                return `
                    <button class="btn btn-sm btn-outline-secondary me-1 duplicate-vendor-pricing-btn" 
                            data-pricing-id="${pricingId}">Duplicate</button>
                    <button class="btn btn-sm btn-outline-danger delete-vendor-pricing-btn" 
                            data-pricing-id="${pricingId}">Delete</button>
                `;
            },
            sortable: false,
            filter: false,
            resizable: false,
            suppressMenu: true
        },
        {
            headerName: "Cost Code",
            field: "cost_code",
            editable: true,
            width: 150,
            filter: 'agSetColumnFilter',
            floatingFilter: true,
            enableRowGroup: true,
            filterParams: { buttons: ['reset', 'apply'], closeOnApply: true }
        },
        {
            headerName: "Item Name",
            field: "item_name",
            editable: true,
            width: 150,
            filter: 'agSetColumnFilter',
            floatingFilter: true,
            enableRowGroup: true,
            filterParams: { buttons: ['reset', 'apply'], closeOnApply: true }
        },
        {
            headerName: "Product Description",
            field: "product_description",
            editable: true,
            width: 180,
            cellEditor: ProductDescriptionEditor,
            cellEditorPopup: false,
            filter: 'agSetColumnFilter',
            floatingFilter: true,
            enableRowGroup: true,
            filterParams: { buttons: ['reset', 'apply'], closeOnApply: true }
        },
        {
            headerName: "Vendor",
            field: "vendor_name",
            editable: true,
            width: 150,
            filter: 'agSetColumnFilter',
            floatingFilter: true,
            enableRowGroup: true,
            filterParams: { buttons: ['reset', 'apply'], closeOnApply: true }
        },
        {
            headerName: "Price",
            field: "price",
            editable: true,
            width: 120,
            cellClass: 'price-cell',
            filter: 'agNumberColumnFilter',
            floatingFilter: true,
            enableValue: true,
            valueFormatter: params => params.value != null ? '$' + Number(params.value).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 4}) : ''
        },
        {
            headerName: "Unit",
            field: "unit_of_measure",
            editable: true,
            width: 100,
            filter: 'agSetColumnFilter',
            floatingFilter: true,
            filterParams: { buttons: ['reset', 'apply'], closeOnApply: true }
        },
        {
            headerName: "Price Type",
            field: "price_type",
            editable: true,
            width: 120,
            filter: 'agSetColumnFilter',
            floatingFilter: true,
            filterParams: { buttons: ['reset', 'apply'], closeOnApply: true }
        },
        {
            headerName: "Notes",
            field: "notes",
            editable: true,
            flex: 1,
            tooltipField: "notes",
            wrapText: true,
            // autoHeight: true, // REMOVE to fix refresh bug
            filter: 'agTextColumnFilter',
            floatingFilter: true,
            filterParams: { buttons: ['reset', 'apply'], closeOnApply: true }
        }
    ];

    const gridOptions = {
        columnDefs: columnDefs,
        defaultColDef: {
            sortable: true,
            filter: true,
            resizable: true,
            editable: true,
            floatingFilter: true,
            enableRowGroup: true,
            enableValue: true,
            enablePivot: true
        },
        enableRangeSelection: true,
        rowSelection: 'multiple',
        animateRows: true,
        // No row grouping
        sideBar: {
            toolPanels: [
                {
                    id: 'columns',
                    labelDefault: 'Columns',
                    labelKey: 'columns',
                    iconKey: 'columns',
                    toolPanel: 'agColumnsToolPanel'
                },
                {
                    id: 'filters',
                    labelDefault: 'Filters',
                    labelKey: 'filters',
                    iconKey: 'filter',
                    toolPanel: 'agFiltersToolPanel'
                }
            ],
            defaultToolPanel: 'columns'
        },
        statusBar: {
            statusPanels: [
                { statusPanel: 'agTotalAndFilteredRowCountComponent', align: 'left' },
                { statusPanel: 'agSelectedRowCountComponent', align: 'left' },
                { statusPanel: 'agAggregationComponent', align: 'right' }
            ]
        },
        pagination: true,
        paginationPageSize: 100,
        onGridReady: onGridReady,
        onCellValueChanged: onCellValueChanged,
        getContextMenuItems: getContextMenuItems
    };

    document.addEventListener('DOMContentLoaded', function() {
        productDescPromise.then(() => {
            const gridDiv = document.querySelector('#vendorPricingGrid');
            gridApi = agGrid.createGrid(gridDiv, gridOptions);
            
            // Add event delegation for action buttons
            gridDiv.addEventListener('click', function(e) {
                if (e.target.classList.contains('duplicate-vendor-pricing-btn')) {
                    e.preventDefault();
                    e.stopPropagation();
                    const pricingId = e.target.getAttribute('data-pricing-id');
                    console.log('Duplicate button clicked for pricing_id:', pricingId);
                    openDuplicateModalById(pricingId);
                } else if (e.target.classList.contains('delete-vendor-pricing-btn')) {
                    e.preventDefault();
                    e.stopPropagation();
                    const pricingId = e.target.getAttribute('data-pricing-id');
                    console.log('Delete button clicked for pricing_id:', pricingId);
                    deleteVendorPricing(pricingId);
                }
            });
        });
    });

    async function loadData() {
        showStatus('Loading vendor pricing data...', 'info');
        const response = await fetch('/api/vendor-pricing');
        if (!response.ok) {
            showStatus('Error loading data', 'error');
            return;
        }
        const data = await response.json();
        allData = data;
        gridApi.setGridOption('rowData', data);
        // Expand all groups by default
        setTimeout(() => {
            gridApi.forEachNode(node => {
                if (node.group) node.setExpanded(true);
            });
        }, 100);
        showStatus(`Loaded ${data.length} vendor pricing records`, 'success');
    }

    function onGridReady(params) {
        gridApi = params.api;
        gridColumnApi = params.columnApi;
        loadData();
    }

    function onCellValueChanged(event) {
        const { data, colDef, newValue, oldValue } = event;
        if (JSON.stringify(newValue) === JSON.stringify(oldValue)) return;

        if (colDef.field === "item_name") {
            data.product_description = '';
            data.product_id = '';
            gridApi.refreshCells({ rowNodes: [event.node], columns: ['product_description'], force: true });
        }

        // If Product Description changed, update product_id and send to backend
        if (colDef.field === "product_description") {
            // newValue is now a string (product_description), product_id is in data.product_id
            if (!data.product_id) {
                showStatus('Please select a valid product', 'warning');
                return;
            }
            data.product_description = newValue;
            fetch(`/api/vendor-pricing/${data.pricing_id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ product_id: data.product_id })
            })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    showStatus('Product updated', 'success');
                    refreshGrid();
                } else {
                    showStatus('Update failed: ' + (result.message || 'Unknown error'), 'error');
                    event.node.setDataValue(colDef.field, oldValue);
                }
            })
            .catch(() => {
                showStatus('Error updating product', 'error');
                event.node.setDataValue(colDef.field, oldValue);
            });
            return;
        }

        // Default: update other fields as before
        fetch(`/api/vendor-pricing/${data.pricing_id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ [colDef.field]: newValue })
        })
        .then(res => res.json())
        .then(result => {
            if (result.success) {
                showStatus('Row updated', 'success');
                refreshGrid();
            } else {
                showStatus('Update failed: ' + (result.message || 'Unknown error'), 'error');
                event.node.setDataValue(colDef.field, oldValue);
            }
        })
        .catch(() => {
            showStatus('Error updating row', 'error');
            event.node.setDataValue(colDef.field, oldValue);
        });
    }

    function getContextMenuItems(params) {
        const items = [
            'copy', 'copyWithHeaders', 'paste',
            'separator',
            {
                name: 'Duplicate Row',
                action: () => duplicateRow(params.node)
            },
            {
                name: 'Delete Row',
                action: () => deleteRow(params.node)
            }
        ];
        return items;
    }

    function refreshGrid() {
        loadData();
    }

    function exportToCsv() {
        gridApi.exportDataAsCsv({ fileName: 'vendor_pricing.csv' });
        showStatus('Exported to CSV', 'success');
    }

    function exportToExcel() {
        gridApi.exportDataAsExcel({ fileName: 'vendor_pricing.xlsx', sheetName: 'Vendor Pricing' });
        showStatus('Exported to Excel', 'success');
    }

    function downloadTemplate(format) {
        window.open(`/api/vendor-pricing/template/${format}`, '_blank');
    }

    function addRow() {
        const newRow = {
            cost_code: '', item_name: '', product_description: '', vendor_name: '',
            price: 0, unit_of_measure: '', price_type: '', notes: ''
        };
        fetch('/api/vendor-pricing', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newRow)
        })
        .then(res => res.json())
        .then(result => {
            if (result.success) {
                showStatus('Row added', 'success');
                refreshGrid();
            } else {
                showStatus('Add failed: ' + (result.message || 'Unknown error'), 'error');
            }
        })
        .catch(() => showStatus('Error adding row', 'error'));
    }

    function duplicateRow(node) {
        let selected = node ? [node] : gridApi.getSelectedNodes();
        if (selected.length === 0) {
            showStatus('Select a row to duplicate', 'warning');
            return;
        }
        const rowData = selected[0].data;
        const duplicate = { ...rowData };
        delete duplicate.pricing_id;
        fetch('/api/vendor-pricing', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(duplicate)
        })
        .then(res => res.json())
        .then(result => {
            if (result.success) {
                showStatus('Row duplicated', 'success');
                refreshGrid();
            } else {
                showStatus('Duplicate failed: ' + (result.message || 'Unknown error'), 'error');
            }
        })
        .catch(() => showStatus('Error duplicating row', 'error'));
    }

    function deleteRow(node) {
        let selected = node ? [node] : gridApi.getSelectedNodes();
        if (selected.length === 0) {
            showStatus('Select a row to delete', 'warning');
            return;
        }
        const pricingId = selected[0].data.pricing_id;
        if (!pricingId) {
            showStatus('Cannot delete unsaved row', 'warning');
            return;
        }
        if (!confirm('Delete this row?')) return;
        fetch(`/api/vendor-pricing/${pricingId}`, { method: 'DELETE' })
        .then(res => res.json())
        .then(result => {
            if (result.success) {
                showStatus('Row deleted', 'success');
                refreshGrid();
            } else {
                showStatus('Delete failed: ' + (result.message || 'Unknown error'), 'error');
            }
        })
        .catch(() => showStatus('Error deleting row', 'error'));
    }

    function showStatus(message, type = 'info') {
        const statusDiv = document.getElementById('statusMessage');
        const alertClass = {
            'success': 'alert-success',
            'error': 'alert-danger',
            'warning': 'alert-warning',
            'info': 'alert-info'
        }[type] || 'alert-info';
        statusDiv.innerHTML = `<div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
        if (type === 'success' || type === 'info') {
            setTimeout(() => {
                const alert = statusDiv.querySelector('.alert');
                if (alert) alert.remove();
            }, 4000);
        }
    }

    function showBulkImportModal() {
        alert('Bulk import modal not implemented in this refactor. Please use the existing import endpoint.');
    }

    function showQuickStats() {
        alert('Quick stats modal not implemented in this refactor. Please use the existing stats logic.');
    }

    // Function to populate product description dropdown based on item_name
    function populateProductDescriptionDropdown(itemName, selectedProductId) {
        const dropdown = document.getElementById('dup_product_description');
        // Clear existing options
        dropdown.innerHTML = '<option value="">Select Product Description</option>';
        
        if (itemName && productDescMap[itemName]) {
            const options = productDescMap[itemName];
            options.forEach(optObj => {
                const option = document.createElement('option');
                option.value = optObj.product_id;
                option.textContent = optObj.product_description;
                if (optObj.product_id == selectedProductId) {
                    option.selected = true;
                }
                dropdown.appendChild(option);
            });
        }
    }

    // Add event listener for item name changes in the modal
    document.addEventListener('DOMContentLoaded', function() {
        const itemNameInput = document.getElementById('dup_item_name');
        if (itemNameInput) {
            itemNameInput.addEventListener('input', function() {
                const itemName = this.value.trim();
                populateProductDescriptionDropdown(itemName, null);
            });
        }
    });

    // Duplicate Vendor Pricing Modal Logic (copied from working products UI pattern)
    let duplicateRowData = null;

    function openDuplicateModalById(pricingId) {
        try {
            console.log('openDuplicateModalById called with pricing_id:', pricingId);
            
            if (!gridApi) {
                console.error('gridApi not available');
                return;
            }
            
            // Find the row data directly from AG-Grid
            let foundRowData = null;
            gridApi.forEachNode(node => {
                if (node.data && node.data.pricing_id == pricingId) {
                    foundRowData = node.data;
                }
            });
            
            if (!foundRowData) {
                console.error('Could not find pricing data for ID:', pricingId);
                showStatus('Could not find vendor pricing data to duplicate.', 'error');
                return;
            }
            
            console.log('Found row data:', foundRowData);
            duplicateRowData = { ...foundRowData };
            
            // Pre-fill modal fields with proper date formatting
            document.getElementById('dup_cost_code').value = duplicateRowData.cost_code || '';
            document.getElementById('dup_item_name').value = duplicateRowData.item_name || '';
            
            // Populate product description dropdown based on item_name
            populateProductDescriptionDropdown(duplicateRowData.item_name, duplicateRowData.product_id);
            document.getElementById('dup_vendor_name').value = duplicateRowData.vendor_name || '';
            document.getElementById('dup_price').value = duplicateRowData.price || '';
            document.getElementById('dup_unit_of_measure').value = duplicateRowData.unit_of_measure || 'EA';
            document.getElementById('dup_price_type').value = duplicateRowData.price_type || '';
            document.getElementById('dup_notes').value = duplicateRowData.notes || '';
            
            // Format dates properly for HTML date inputs (YYYY-MM-DD)
            const formatDateForInput = (dateString) => {
                if (!dateString) return '';
                try {
                    const date = new Date(dateString);
                    return date.toISOString().split('T')[0];
                } catch (e) {
                    return '';
                }
            };
            
            document.getElementById('dup_effective_date').value = formatDateForInput(duplicateRowData.effective_date);
            document.getElementById('dup_expiration_date').value = formatDateForInput(duplicateRowData.expiration_date);
            document.getElementById('dup_minimum_quantity').value = duplicateRowData.minimum_quantity || '';
            
            console.log('About to show modal');
            
            // Show modal using the same pattern as products UI
            const modal = new bootstrap.Modal(document.getElementById('duplicateVendorPricingModal'));
            modal.show();
            
            console.log('Modal show() called');
        } catch (e) {
            console.error('Error in openDuplicateModalById:', e);
            showStatus('Failed to open duplicate modal: ' + e.message, 'error');
        }
    }

    async function deleteVendorPricing(pricingId) {
        if (!confirm('Are you sure you want to delete this vendor pricing record?')) return;
        
        try {
            const response = await fetch(`/api/vendor-pricing/${pricingId}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) throw new Error('Failed to delete vendor pricing');
            
            await refreshGrid();
            showStatus('Vendor pricing deleted successfully', 'success');
            
        } catch (error) {
            console.error('Error deleting vendor pricing:', error);
            showStatus('Failed to delete vendor pricing', 'error');
        }
    }

    function showDuplicateModal() {
        try {
            const selected = gridApi.getSelectedNodes();
            if (selected.length === 0) {
                showStatus('Please select a row to duplicate', 'warning');
                return;
            }
            
            duplicateRowData = { ...selected[0].data };
            
            // Pre-fill modal fields with proper date formatting
            document.getElementById('dup_cost_code').value = duplicateRowData.cost_code || '';
            document.getElementById('dup_item_name').value = duplicateRowData.item_name || '';
            document.getElementById('dup_product_description').value = duplicateRowData.product_description || '';
            document.getElementById('dup_vendor_name').value = duplicateRowData.vendor_name || '';
            document.getElementById('dup_price').value = duplicateRowData.price || '';
            document.getElementById('dup_unit_of_measure').value = duplicateRowData.unit_of_measure || 'EA';
            document.getElementById('dup_price_type').value = duplicateRowData.price_type || '';
            document.getElementById('dup_notes').value = duplicateRowData.notes || '';
            
            // Format dates properly for HTML date inputs (YYYY-MM-DD)
            const formatDateForInput = (dateString) => {
                if (!dateString) return '';
                try {
                    const date = new Date(dateString);
                    return date.toISOString().split('T')[0];
                } catch (e) {
                    return '';
                }
            };
            
            document.getElementById('dup_effective_date').value = formatDateForInput(duplicateRowData.effective_date);
            document.getElementById('dup_expiration_date').value = formatDateForInput(duplicateRowData.expiration_date);
            document.getElementById('dup_minimum_quantity').value = duplicateRowData.minimum_quantity || '';
            
            // Show modal using the same pattern as products UI
            const modal = new bootstrap.Modal(document.getElementById('duplicateVendorPricingModal'));
            modal.show();
        } catch (e) {
            showStatus('Failed to open duplicate modal', 'error');
            console.error('Error opening duplicate modal:', e);
        }
    }

    async function saveDuplicateVendorPricing() {
        console.log('saveDuplicateVendorPricing called');
        try {
            // Get values from form fields
            const vendor_name = document.getElementById('dup_vendor_name').value.trim();
            const price = parseFloat(document.getElementById('dup_price').value) || 0;
            const unit_of_measure = document.getElementById('dup_unit_of_measure').value.trim() || 'EA';
            const price_type = document.getElementById('dup_price_type').value.trim();
            const notes = document.getElementById('dup_notes').value.trim();
            const effective_date = document.getElementById('dup_effective_date').value || null;
            const expiration_date = document.getElementById('dup_expiration_date').value || null;
            const minimum_quantity = parseInt(document.getElementById('dup_minimum_quantity').value) || null;
            
            // Get selected product_id from dropdown
            const selectedProductId = document.getElementById('dup_product_description').value || duplicateRowData.product_id;

            // Validate required fields
            if (!vendor_name || !price) {
                showStatus('Vendor name and price are required', 'error');
                return;
            }

            // Build data object following the backend API structure
            const data = {
                vendor_name: vendor_name,
                price: price,
                unit_of_measure: unit_of_measure,
                price_type: price_type || null,
                notes: notes || null,
                effective_date: effective_date,
                expiration_date: expiration_date,
                minimum_quantity: minimum_quantity,
                product_id: selectedProductId, // Use selected product_id from dropdown
                vendor_id: duplicateRowData.vendor_id || null, // Keep original vendor_id if available
                is_current: true,
                is_active: true
            };

            console.log('saveDuplicateVendorPricing payload:', JSON.stringify(data, null, 2));

            // Use the duplicate API endpoint
            const response = await fetch(`/api/vendor-pricing/${duplicateRowData.pricing_id}/duplicate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            console.log('Response data:', JSON.stringify(result, null, 2));
            
            if (!response.ok) {
                throw new Error(result.message || 'Failed to duplicate vendor pricing');
            }

            // Hide modal first
            const modalElement = document.getElementById('duplicateVendorPricingModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }

            // Clear form for next use
            document.getElementById('duplicateVendorPricingForm').reset();

            // Refresh grid data
            await refreshGrid();
            showStatus('Vendor pricing duplicated successfully!', 'success');

            // Focus on the new row if ID is available
            if (result.pricing_id && gridApi) {
                setTimeout(() => {
                    gridApi.forEachNode(node => {
                        if (node.data && node.data.pricing_id == result.pricing_id) {
                            node.setSelected(true, true);
                            gridApi.ensureIndexVisible(node.rowIndex, 'middle');
                            // Start editing the price field
                            gridApi.startEditingCell({
                                rowIndex: node.rowIndex,
                                colKey: 'price'
                            });
                        }
                    });
                }, 500);
            }

        } catch (error) {
            console.error('Duplicate vendor pricing error:', error);
            showStatus('Failed to duplicate: ' + error.message, 'error');
        }
    }
</script>

<!-- Duplicate Vendor Pricing Modal -->
<div class="modal fade" id="duplicateVendorPricingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Duplicate Vendor Pricing</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                <form id="duplicateVendorPricingForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Cost Code</label>
                                <input type="text" class="form-control" name="cost_code" id="dup_cost_code">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Item Name</label>
                                <input type="text" class="form-control" name="item_name" id="dup_item_name">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Product Description</label>
                                <select class="form-control" name="product_description" id="dup_product_description">
                                    <option value="">Select Product Description</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Vendor Name *</label>
                                <input type="text" class="form-control" name="vendor_name" id="dup_vendor_name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Price *</label>
                                <input type="number" step="0.01" class="form-control" name="price" id="dup_price" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Unit of Measure</label>
                                <select class="form-control" name="unit_of_measure" id="dup_unit_of_measure">
                                    <option value="EA">Each (EA)</option>
                                    <option value="SF">Square Feet (SF)</option>
                                    <option value="LF">Linear Feet (LF)</option>
                                    <option value="LB">Pounds (LB)</option>
                                    <option value="GAL">Gallons (GAL)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Price Type</label>
                                <select class="form-control" name="price_type" id="dup_price_type">
                                    <option value="">Select Type</option>
                                    <option value="quote">Quote</option>
                                    <option value="list">List Price</option>
                                    <option value="net">Net Price</option>
                                    <option value="contract">Contract Price</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Effective Date</label>
                                <input type="date" class="form-control" name="effective_date" id="dup_effective_date">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Expiration Date</label>
                                <input type="date" class="form-control" name="expiration_date" id="dup_expiration_date">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Minimum Quantity</label>
                                <input type="number" class="form-control" name="minimum_quantity" id="dup_minimum_quantity">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" name="notes" id="dup_notes" rows="4"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveDuplicateVendorPricing()">Save Duplicate</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
