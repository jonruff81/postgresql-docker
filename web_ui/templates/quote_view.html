{% extends "base.html" %}

{% block title %}Quote Details - PostgreSQL Takeoff Database{% endblock %}
{% block page_title %}
Quote Details - {{ quote.quote_number or 'Q-' + quote.quote_id|string }}
<small class="text-muted">{{ quote.vendor_name }}</small>
{% endblock %}

{% block page_actions %}
<div class="btn-group" role="group">
    <a href="{{ url_for('quotes_list') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Quotes
    </a>
    <a href="{{ url_for('edit_quote', quote_id=quote.quote_id) }}" class="btn btn-outline-primary">
        <i class="bi bi-pencil"></i> Edit Quote
    </a>
    <a href="{{ url_for('quote_line_items', quote_id=quote.quote_id) }}" class="btn btn-success">
        <i class="bi bi-list-ul"></i> Manage Line Items
    </a>
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-info dropdown-toggle" data-bs-toggle="dropdown">
            <i class="bi bi-download"></i> Export
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="exportQuote('pdf')"><i class="bi bi-file-pdf"></i> Export as PDF</a></li>
            <li><a class="dropdown-item" href="#" onclick="exportQuote('excel')"><i class="bi bi-file-excel"></i> Export to Excel</a></li>
        </ul>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Quote Information Card -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-file-earmark-text"></i> Quote Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Quote Number:</strong></td>
                                    <td>{{ quote.quote_number or 'Q-' + quote.quote_id|string }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Vendor:</strong></td>
                                    <td>{{ quote.vendor_name }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Quote Date:</strong></td>
                                    <td>{{ quote.quote_date.strftime('%Y-%m-%d') if quote.quote_date else '-' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Expiration Date:</strong></td>
                                    <td>
                                        {% if quote.expiration_date %}
                                            {% set is_expired = quote.expiration_date < today %}
                                            <span class="badge {{ 'bg-danger' if is_expired else 'bg-success' }}">
                                                {{ quote.expiration_date.strftime('%Y-%m-%d') }}
                                                {% if is_expired %} (Expired){% endif %}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">No expiration</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Status:</strong></td>
                                    <td>
                                        {% set status_class = {
                                            'active': 'success',
                                            'expired': 'danger',
                                            'accepted': 'primary',
                                            'rejected': 'secondary',
                                            'superseded': 'warning'
                                        } %}
                                        <span class="badge bg-{{ status_class.get(quote.status, 'secondary') }}">
                                            {{ quote.status|title }}
                                        </span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                {% if quote.contact_person %}
                                <tr>
                                    <td><strong>Contact Person:</strong></td>
                                    <td>{{ quote.contact_person }}</td>
                                </tr>
                                {% endif %}
                                {% if quote.contact_email %}
                                <tr>
                                    <td><strong>Contact Email:</strong></td>
                                    <td><a href="mailto:{{ quote.contact_email }}">{{ quote.contact_email }}</a></td>
                                </tr>
                                {% endif %}
                                {% if quote.contact_phone %}
                                <tr>
                                    <td><strong>Contact Phone:</strong></td>
                                    <td><a href="tel:{{ quote.contact_phone }}">{{ quote.contact_phone }}</a></td>
                                </tr>
                                {% endif %}
                                <tr>
                                    <td><strong>Total Amount:</strong></td>
                                    <td>
                                        {% if quote.total_amount %}
                                            <strong class="text-success">${{ "{:,.2f}".format(quote.total_amount) }}</strong>
                                        {% else %}
                                            <span class="text-muted">Not specified</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Created Date:</strong></td>
                                    <td>{{ quote.created_date.strftime('%Y-%m-%d %H:%M') if quote.created_date else '-' }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    {% if quote.notes %}
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Notes:</h6>
                            <div class="bg-light p-3 rounded">
                                {{ quote.notes }}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Quick Stats Card -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up"></i> Quote Summary
                    </h5>
                </div>
                <div class="card-body text-center">
                    <div class="row">
                        <div class="col-6">
                            <div class="bg-primary text-white p-3 rounded mb-2">
                                <h4 class="mb-0">{{ line_items|length }}</h4>
                                <small>Line Items</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="bg-info text-white p-3 rounded mb-2">
                                <h4 class="mb-0">{{ attachments|length }}</h4>
                                <small>Attachments</small>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            {% set line_total = line_items|sum(attribute='line_total') %}
                            <div class="bg-success text-white p-3 rounded">
                                <h4 class="mb-0">${{ "{:,.2f}".format(line_total) if line_total else "0.00" }}</h4>
                                <small>Line Items Total</small>
                            </div>
                        </div>
                    </div>

                    {% if quote.plan_name or quote.job_name %}
                    <div class="mt-3">
                        <h6>Associated Project:</h6>
                        {% if quote.plan_name %}
                        <p class="mb-1"><strong>Plan:</strong> {{ quote.plan_name }}</p>
                        {% endif %}
                        {% if quote.job_name %}
                        <p class="mb-0"><strong>Job:</strong> {{ quote.job_name }}</p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Line Items Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-list-ul"></i> Line Items
                    </h5>
                    <div>
                        <span class="badge bg-primary">{{ line_items|length }} items</span>
                        <a href="{{ url_for('quote_line_items', quote_id=quote.quote_id) }}" class="btn btn-sm btn-success">
                            <i class="bi bi-plus-circle"></i> Manage Items
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if line_items %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Cost Code</th>
                                    <th>Description</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>UOM</th>
                                    <th>Line Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in line_items %}
                                <tr>
                                    <td>
                                        {% if item.cost_code %}
                                            <span class="badge bg-info">{{ item.cost_code }}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="fw-bold">{{ item.product_description or item.item_name or 'Unnamed Product' }}</div>
                                        {% if item.notes %}
                                        <small class="text-muted">{{ item.notes }}</small>
                                        {% endif %}
                                    </td>
                                    <td>{{ item.quantity or '-' }}</td>
                                    <td>
                                        {% if item.unit_price %}
                                            ${{ "{:,.2f}".format(item.unit_price) }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ item.unit_of_measure or '-' }}</td>
                                    <td>
                                        {% if item.line_total %}
                                            <strong>${{ "{:,.2f}".format(item.line_total) }}</strong>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                                <tr class="table-info">
                                    <td colspan="5"><strong>Total:</strong></td>
                                    <td><strong>${{ "{:,.2f}".format(line_items|sum(attribute='line_total') or 0) }}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-list-ul fs-1 text-muted"></i>
                        <h5 class="text-muted mt-3">No line items yet</h5>
                        <p class="text-muted">Add line items to break down this quote.</p>
                        <a href="{{ url_for('quote_line_items', quote_id=quote.quote_id) }}" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Add Line Items
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- File Attachments Section -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-paperclip"></i> File Attachments
                    </h5>
                    <span class="badge bg-secondary">{{ attachments|length }} files</span>
                </div>
                <div class="card-body">
                    {% if attachments %}
                    <div class="row">
                        {% for attachment in attachments %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card border">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            {% if attachment.file_name.lower().endswith('.pdf') %}
                                                <i class="bi bi-file-pdf text-danger fs-2"></i>
                                            {% elif attachment.file_name.lower().endswith(('.xlsx', '.xls')) %}
                                                <i class="bi bi-file-excel text-success fs-2"></i>
                                            {% elif attachment.file_name.lower().endswith(('.doc', '.docx')) %}
                                                <i class="bi bi-file-word text-primary fs-2"></i>
                                            {% elif attachment.file_name.lower().endswith(('.png', '.jpg', '.jpeg')) %}
                                                <i class="bi bi-file-image text-info fs-2"></i>
                                            {% else %}
                                                <i class="bi bi-file-earmark text-secondary fs-2"></i>
                                            {% endif %}
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">{{ attachment.file_name }}</h6>
                                            <small class="text-muted">
                                                Uploaded: {{ attachment.uploaded_date.strftime('%Y-%m-%d %H:%M') if attachment.uploaded_date else 'Unknown' }}
                                            </small>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <a href="{{ url_for('download_quote_file', file_id=attachment.file_id) }}" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-download"></i> Download
                                        </a>
                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteAttachment({{ attachment.file_id }})">
                                            <i class="bi bi-trash"></i> Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-paperclip fs-1 text-muted"></i>
                        <h5 class="text-muted mt-3">No attachments</h5>
                        <p class="text-muted">No files have been attached to this quote yet.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function exportQuote(format) {
    if (format === 'pdf') {
        // Generate PDF export
        window.print();
    } else if (format === 'excel') {
        // Export to Excel (would need to implement server-side endpoint)
        alert('Excel export functionality will be implemented');
    }
}

function deleteAttachment(fileId) {
    if (confirm('Are you sure you want to delete this attachment?')) {
        fetch(`/quotes/{{ quote.quote_id }}/attachments/${fileId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting attachment: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error deleting attachment');
            console.error('Error:', error);
        });
    }
}

// Print styles for PDF export
const printStyles = `
<style>
@media print {
    .btn, .badge, .card-header .btn-group, .navbar, .sidebar {
        display: none !important;
    }
    .card {
        border: 1px solid #000 !important;
        box-shadow: none !important;
    }
    .table {
        border: 1px solid #000 !important;
    }
    .table th, .table td {
        border: 1px solid #000 !important;
    }
}
</style>
`;

// Add print styles to head
document.head.insertAdjacentHTML('beforeend', printStyles);
</script>
{% endblock %}
