<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Takeoff Analysis - AG Grid</title>
    
    <!-- AG Grid Enterprise CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-enterprise@30.2.0/styles/ag-grid.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-enterprise@30.2.0/styles/ag-theme-alpine.css">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        .ag-theme-alpine {
            font-size: 14px;
        }
        .grid-container {
            height: 600px;
            width: 100%;
        }
        .header-section {
            margin-bottom: 20px;
        }
        .btn-group {
            margin-bottom: 15px;
        }
        .status-message {
            margin-top: 10px;
        }
        .duplicated-row {
            background-color: #e3f2fd !important;
        }
        .ag-row.duplicated-row {
            background-color: #e3f2fd !important;
        }
        .ag-row.duplicated-row .ag-cell {
            background-color: #e3f2fd !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-3">
        <!-- Header Section -->
        <div class="header-section">
            <div class="row">
                <div class="col-md-8">
                    <h2><i class="fas fa-chart-line"></i> Comprehensive Takeoff Analysis</h2>
                    <p class="text-muted">Complete takeoff analysis with plan options, cost codes, items, quantities, pricing, and vendor information</p>
                </div>
                <div class="col-md-4 text-end">
                    <a href="/" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </a>
                </div>
            </div>
        </div>


        <!-- Toggle Summary Button -->
        <div class="row mb-3">
            <div class="col-md-12">
                <button type="button" class="btn btn-outline-success" onclick="toggleSummary()">
                    <i class="fas fa-chart-pie" id="summaryToggleIcon"></i> <span id="summaryToggleText">Show Summary</span>
                </button>
                <small class="text-muted ms-3">Toggle pricing summary cards</small>
            </div>
        </div>

        <!-- Summary Cards Section -->
        <div id="summaryCardsSection" class="mb-3" style="display: none;">
            <!-- Summary Header -->
            <div class="row mb-2">
                <div class="col-md-12">
                    <h6 class="text-muted">
                        <i class="fas fa-chart-pie"></i> Plan & Option Summary (Filtered Data: <span id="totalExtendedPrice">$0.00</span> | <span id="totalRecords">0</span> records)
                    </h6>
                </div>
            </div>
            
            <!-- Individual Plan/Option Cards -->
            <div id="planOptionCards" class="row">
                <!-- Individual cards will be populated here -->
            </div>
        </div>

        <!-- Control Panel -->
        <div class="row mb-3">
            <div class="col-md-12">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-warning" onclick="refreshGrid()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button type="button" class="btn btn-info" onclick="exportToCSV()">
                        <i class="fas fa-download"></i> Export CSV
                    </button>
                    <button type="button" class="btn btn-success" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i> Export Excel
                    </button>
                </div>
                <div class="btn-group ms-2" role="group">
                    <button type="button" class="btn btn-outline-secondary" onclick="clearAllFilters()">
                        <i class="fas fa-filter"></i> Clear All Filters
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="fitColumns()">
                        <i class="fas fa-arrows-alt-h"></i> Fit Columns
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="autoSizeColumns()">
                        <i class="fas fa-expand-arrows-alt"></i> Auto Size
                    </button>
                </div>
                <div class="btn-group ms-2" role="group">
                    <button type="button" class="btn btn-primary" onclick="getQuickStats()">
                        <i class="fas fa-chart-bar"></i> Quick Stats
                    </button>
                </div>
                <div class="btn-group ms-2" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="duplicateSelectedRows()">
                        <i class="fas fa-copy"></i> Duplicate Row
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="deleteSelectedRow()">
                        <i class="fas fa-trash"></i> Delete Row
                    </button>
                </div>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="statusMessages" class="status-message"></div>

        <!-- AG Grid Container -->
        <div class="grid-container">
            <div id="comprehensiveTakeoffGrid" class="ag-theme-alpine" style="height: 100%; width: 100%;"></div>
        </div>

        <!-- Grid Info -->
        <div class="row mt-3">
            <div class="col-md-6">
                <small class="text-muted">
                    <span id="rowCount">0</span> records | 
                    <span id="selectedCount">0</span> selected |
                    <span id="filteredCount">0</span> filtered
                </small>
            </div>
            <div class="col-md-6 text-end">
                <small class="text-muted">
                    Advanced filtering and export capabilities available
                </small>
            </div>
        </div>
    </div>

    <!-- Quick Stats Modal -->
    <div class="modal fade" id="statsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Takeoff Analysis Statistics</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="statsContent">
                    <!-- Stats content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- AG Grid Enterprise JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-enterprise@30.2.0/dist/ag-grid-enterprise.min.js"></script>
    
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Set AG Grid Enterprise License Key
        agGrid.LicenseManager.setLicenseKey("Using_this_{AG_Grid}_Enterprise_key_{AG-090866}_in_excess_of_the_licence_granted_is_not_permitted___Please_report_misuse_to_legal@ag-grid.com___For_help_with_changing_this_key_please_contact_info@ag-grid.com___{Jon_Ruff}_is_granted_a_{Single_Application}_Developer_License_for_the_application_{7.2.25_postgress/docker}_only_for_{1}_Front-End_JavaScript_developer___All_Front-End_JavaScript_developers_working_on_{7.2.25_postgress/docker}_need_to_be_licensed___{7.2.25_postgress/docker}_has_not_been_granted_a_Deployment_License_Add-on___This_key_works_with_{AG_Grid}_Enterprise_versions_released_before_{3_July_2026}____[v3]_[01]_MTc4MzAzMzIwMDAwMA==19f186f51d3d529c90499fde9cba373b");

        let gridApi;
        let gridColumnApi;
        let gridData = [];
        
        // Dependency mappings for cascading dropdowns
        let dependencyMappings = {
            planToOptions: new Map(),
            costCodeToItems: new Map(),
            vendorToItems: new Map(),
            jobToCustomers: new Map(),
            allVendors: new Set(),
            allJobs: new Set(),
            allCustomers: new Set(),
            allCostCodes: new Set(),
            allItemNames: new Set()
        };

        // Track duplicated rows for blue highlighting
        let duplicatedRowIds = new Set();
        let nextRowId = 1;

        // Grid column definitions with AG-Grid mini filters
        const columnDefs = [
            {
                headerName: "Select",
                checkboxSelection: true,
                headerCheckboxSelection: false,
                width: 50,
                pinned: 'left',
                lockPosition: true,
                suppressMenu: true,
                suppressSorting: true,
                suppressFilter: true
            },
            {
                headerName: "Plan Info",
                children: [
                    { 
                        field: "plan_full_name", 
                        headerName: "Plan Name", 
                        filter: 'agSetColumnFilter',
                        filterParams: {
                            buttons: ['reset', 'apply'],
                            closeOnApply: true,
                            suppressSelectAll: false,
                            newRowsAction: 'keep'
                        },
                        sort: "asc", 
                        pinned: 'left', 
                        width: 180 
                    },
                    { 
                        field: "option_name", 
                        headerName: "Option", 
                        filter: 'agSetColumnFilter',
                        filterParams: {
                            buttons: ['reset', 'apply'],
                            closeOnApply: true,
                            suppressSelectAll: false,
                            newRowsAction: 'keep'
                        },
                        pinned: 'left', 
                        width: 120 
                    }
                ]
            },
            {
                headerName: "Cost Details",
                children: [
                    { 
                        field: "cost_code", 
                        headerName: "Cost Code", 
                        filter: 'agSetColumnFilter',
                        filterParams: {
                            buttons: ['reset', 'apply'],
                            closeOnApply: true,
                            suppressSelectAll: false,
                            newRowsAction: 'keep'
                        },
                        width: 100,
                        editable: true,
                        cellEditor: 'agSelectCellEditor',
                        cellEditorParams: {
                            values: () => Array.from(dependencyMappings.allCostCodes).sort()
                        },
                        cellStyle: params => params.data ? {'background-color': '#f8f9fa'} : null
                    },
                    { 
                        field: "item_name", 
                        headerName: "Item Name", 
                        filter: 'agSetColumnFilter',
                        filterParams: {
                            buttons: ['reset', 'apply'],
                            closeOnApply: true,
                            suppressSelectAll: false,
                            newRowsAction: 'keep'
                        },
                        width: 200,
                        editable: true,
                        cellEditor: 'agSelectCellEditor',
                        cellEditorParams: (params) => {
                            // Get items based on cost code if available
                            let values = Array.from(dependencyMappings.allItemNames).sort();
                            if (params.data && params.data.cost_code) {
                                const costCodeItems = getItemsForCostCode(params.data.cost_code);
                                if (costCodeItems.length > 0) {
                                    values = costCodeItems;
                                }
                            }
                            // Also consider vendor if available
                            if (params.data && params.data.vendor_name) {
                                const vendorItems = getItemsForVendor(params.data.vendor_name);
                                if (vendorItems.length > 0) {
                                    // Find intersection or union depending on requirements
                                    values = vendorItems.filter(item => values.includes(item));
                                    if (values.length === 0) values = vendorItems;
                                }
                            }
                            return { values: values };
                        },
                        cellStyle: params => params.data ? {'background-color': '#f8f9fa'} : null
                    },
                    {
                        field: "item_description",
                        headerName: "Item Description",
                        filter: 'agSetColumnFilter',
                        filterParams: {
                            buttons: ['reset', 'apply'],
                            closeOnApply: true,
                            suppressSelectAll: false,
                            newRowsAction: 'keep'
                        },
                        width: 250,
                        tooltipField: "item_description",
                        editable: true,
                        cellEditor: 'agLargeTextCellEditor',
                        cellEditorPopup: true,
                        cellStyle: params => params.data ? {'background-color': '#f8f9fa'} : null
                    }
                ]
            },
            {
                headerName: "Quantities & Pricing",
                children: [
                    { 
                        field: "quantity_source", 
                        headerName: "Quantity Source", 
                        filter: 'agSetColumnFilter',
                        filterParams: {
                            buttons: ['reset', 'apply'],
                            closeOnApply: true,
                            suppressSelectAll: false,
                            newRowsAction: 'keep'
                        },
                        width: 140 
                    },
                    {
                        field: "quantity",
                        headerName: "Quantity",
                        filter: 'agSetColumnFilter',
                        filterParams: {
                            buttons: ['reset', 'apply'],
                            closeOnApply: true,
                            suppressSelectAll: false,
                            newRowsAction: 'keep'
                        },
                        cellClass: 'ag-right-aligned-cell',
                        valueFormatter: params => params.value ? parseFloat(params.value).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 4}) : '',
                        width: 100,
                        editable: true,
                        cellEditor: 'agNumberCellEditor',
                        cellEditorParams: {
                            min: 0,
                            precision: 4
                        },
                        valueParser: params => parseFloat(params.newValue) || 0,
                        cellStyle: params => params.data ? {'background-color': '#f8f9fa'} : null
                    },
                    {
                        field: "unit_price",
                        headerName: "Unit Price",
                        filter: 'agSetColumnFilter',
                        filterParams: {
                            buttons: ['reset', 'apply'],
                            closeOnApply: true,
                            suppressSelectAll: false,
                            newRowsAction: 'keep'
                        },
                        cellClass: 'ag-right-aligned-cell',
                        valueFormatter: params => params.value ? '$' + parseFloat(params.value).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '',
                        width: 110,
                        editable: true,
                        cellEditor: 'agNumberCellEditor',
                        cellEditorParams: {
                            min: 0,
                            precision: 2
                        },
                        valueParser: params => parseFloat(params.newValue) || 0,
                        cellStyle: params => params.data ? {'background-color': '#f8f9fa'} : null
                    },
                    {
                        field: "price_factor",
                        headerName: "Price Factor",
                        filter: 'agSetColumnFilter',
                        filterParams: {
                            buttons: ['reset', 'apply'],
                            closeOnApply: true,
                            suppressSelectAll: false,
                            newRowsAction: 'keep'
                        },
                        cellClass: 'ag-right-aligned-cell',
                        valueFormatter: params => params.value ? parseFloat(params.value).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 4}) : '',
                        width: 110,
                        editable: true,
                        cellEditor: 'agNumberCellEditor',
                        cellEditorParams: {
                            min: 0,
                            precision: 4
                        },
                        valueParser: params => parseFloat(params.newValue) || 1,
                        cellStyle: params => params.data ? {'background-color': '#f8f9fa'} : null
                    },
                    { 
                        field: "unit_of_measure", 
                        headerName: "Unit", 
                        filter: 'agSetColumnFilter',
                        filterParams: {
                            buttons: ['reset', 'apply'],
                            closeOnApply: true,
                            suppressSelectAll: false,
                            newRowsAction: 'keep'
                        },
                        width: 80,
                        editable: true,
                        cellEditor: 'agSelectCellEditor',
                        cellEditorParams: {
                            values: ['EA', 'SF', 'LF', 'CF', 'SY', 'LB', 'TON', 'GAL', 'HR']
                        },
                        cellStyle: params => params.data ? {'background-color': '#f8f9fa'} : null
                    },
                    {
                        field: "extended_price",
                        headerName: "Extended Price",
                        filter: 'agSetColumnFilter',
                        filterParams: {
                            buttons: ['reset', 'apply'],
                            closeOnApply: true,
                            suppressSelectAll: false,
                            newRowsAction: 'keep'
                        },
                        cellClass: 'ag-right-aligned-cell',
                        valueFormatter: params => params.value ? '$' + parseFloat(params.value).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '',
                        cellStyle: {'background-color': '#e8f5e8', fontWeight: 'bold'},
                        width: 130,
                        editable: false, // This will be calculated automatically
                        valueGetter: params => {
                            // Calculate extended price from quantity * unit_price * price_factor
                            if (params.data) {
                                const quantity = parseFloat(params.data.quantity || 0);
                                const unitPrice = parseFloat(params.data.unit_price || 0);
                                const priceFactor = parseFloat(params.data.price_factor || 1);
                                return quantity * unitPrice * priceFactor;
                            }
                            return 0;
                        }
                    }
                ]
            },
            {
                headerName: "Additional Info",
                children: [
                    { 
                        field: "vendor_name", 
                        headerName: "Vendor", 
                        filter: 'agSetColumnFilter',
                        filterParams: {
                            buttons: ['reset', 'apply'],
                            closeOnApply: true,
                            suppressSelectAll: false,
                            newRowsAction: 'keep'
                        },
                        width: 150,
                        editable: true,
                        cellEditor: 'agSelectCellEditor',
                        cellEditorParams: {
                            values: () => Array.from(dependencyMappings.allVendors).sort()
                        },
                        cellStyle: params => params.data ? {'background-color': '#f8f9fa'} : null
                    },
                    {
                        field: "notes",
                        headerName: "Notes",
                        filter: 'agSetColumnFilter',
                        filterParams: {
                            buttons: ['reset', 'apply'],
                            closeOnApply: true,
                            suppressSelectAll: false,
                            newRowsAction: 'keep'
                        },
                        width: 200,
                        tooltipField: "notes",
                        editable: true,
                        cellEditor: 'agLargeTextCellEditor',
                        cellEditorPopup: true,
                        cellStyle: params => params.data ? {'background-color': '#f8f9fa'} : null
                    },
                    { 
                        field: "job_name", 
                        headerName: "Job Name", 
                        filter: 'agSetColumnFilter',
                        filterParams: {
                            buttons: ['reset', 'apply'],
                            closeOnApply: true,
                            suppressSelectAll: false,
                            newRowsAction: 'keep'
                        },
                        width: 150 
                    },
                    {
                        field: "job_number",
                        headerName: "Job Number",
                        filter: 'agSetColumnFilter',
                        filterParams: {
                            buttons: ['reset', 'apply'],
                            closeOnApply: true,
                            suppressSelectAll: false,
                            newRowsAction: 'keep'
                        },
                        width: 120
                    },
                    { 
                        field: "customer_name", 
                        headerName: "Customer", 
                        filter: 'agSetColumnFilter',
                        filterParams: {
                            buttons: ['reset', 'apply'],
                            closeOnApply: true,
                            suppressSelectAll: false,
                            newRowsAction: 'keep'
                        },
                        width: 150 
                    },
                    { 
                        field: "room", 
                        headerName: "Room", 
                        filter: 'agSetColumnFilter',
                        filterParams: {
                            buttons: ['reset', 'apply'],
                            closeOnApply: true,
                            suppressSelectAll: false,
                            newRowsAction: 'keep'
                        },
                        width: 120,
                        editable: true,
                        cellStyle: params => params.data ? {'background-color': '#f8f9fa'} : null
                    },
                    { 
                        field: "spec_name", 
                        headerName: "Spec", 
                        filter: 'agSetColumnFilter',
                        filterParams: {
                            buttons: ['reset', 'apply'],
                            closeOnApply: true,
                            suppressSelectAll: false,
                            newRowsAction: 'keep'
                        },
                        width: 120,
                        editable: true,
                        cellStyle: params => params.data ? {'background-color': '#f8f9fa'} : null
                    }
                ]
            }
        ];

        // Grid options
        const gridOptions = {
            columnDefs: columnDefs,
            defaultColDef: {
                sortable: true,
                filter: true,
                resizable: true,
            },
            enableRangeSelection: true,
            enableCharts: true,
            rowSelection: 'single', // Enable single row selection
            rowMultiSelectWithClick: false, // Prevent multi-select
            sideBar: {
                toolPanels: ['columns', 'filters'],
                defaultToolPanel: 'columns'
            },
            statusBar: {
                statusPanels: [
                    { statusPanel: 'agTotalAndFilteredRowCountComponent' },
                    { statusPanel: 'agSelectedRowCountComponent' },
                    { statusPanel: 'agAggregationComponent' }
                ]
            },
            pagination: true,
            paginationPageSize: 500,
            paginationPageSizeSelector: [100, 200, 500, 1000],
            paginationAutoPageSize: false,
            animateRows: true,
            onGridReady: onGridReady,
            onFilterChanged: function() {
                updateRowCount();
                // Update summary cards when filters change (if summary is visible)
                if (document.getElementById('summaryCardsSection').style.display !== 'none') {
                    updateSummaryCards();
                }
            },
            onSelectionChanged: updateRowCount,
            onCellValueChanged: onCellValueChanged,
            undoRedoCellEditing: true,
            undoRedoCellEditingLimit: 20,
            getRowId: (params) => {
                // Use custom row ID if available, otherwise use array index
                return params.data.customRowId || params.data.id || `row_${nextRowId++}`;
            },
            getRowStyle: (params) => {
                // Apply blue background to duplicated rows
                if (params.data && params.data.customRowId && duplicatedRowIds.has(params.data.customRowId)) {
                    return { background: '#e3f2fd' };
                }
                return null;
            }
        };

        // Initialize grid when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const gridDiv = document.querySelector('#comprehensiveTakeoffGrid');
            new agGrid.Grid(gridDiv, gridOptions);
        });

        // Grid ready event - load data here when grid is fully initialized
        function onGridReady(params) {
            gridApi = params.api;
            gridColumnApi = params.columnApi;
            console.log('Grid ready, loading data...');
            
            // Explicitly set page size to ensure it takes effect
            gridApi.paginationSetPageSize(500);
            console.log('Page size set to 500');
            
            loadGridData();
        }

        // Load data from API
        function loadGridData() {
            showStatusMessage('Loading takeoff analysis data...', 'info');
            
            fetch('/api/comprehensive-takeoff-analysis')
                .then(response => response.json())
                .then(data => {
                    gridData = data;
                    buildDependencyMappings(data);
                    gridApi.setRowData(data);
                    updateRowCount();
                    showStatusMessage(`Loaded ${data.length} takeoff records successfully`, 'success');
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                    showStatusMessage('Error loading takeoff analysis data', 'danger');
                });
        }

        // Clear all filters
        function clearAllFilters() {
            gridApi.setFilterModel(null);
            showStatusMessage('All filters cleared', 'info');
        }

        // Refresh grid
        function refreshGrid() {
            loadGridData();
        }

        // Export functions
        function exportToCSV() {
            gridApi.exportDataAsCsv({
                fileName: 'comprehensive_takeoff_analysis.csv'
            });
            showStatusMessage('Data exported to CSV', 'success');
        }

        function exportToExcel() {
            gridApi.exportDataAsExcel({
                fileName: 'comprehensive_takeoff_analysis.xlsx'
            });
            showStatusMessage('Data exported to Excel', 'success');
        }

        // Utility functions
        function clearFilters() {
            gridApi.setFilterModel(null);
            showStatusMessage('Filters cleared', 'info');
        }

        function fitColumns() {
            gridApi.sizeColumnsToFit();
        }

        function autoSizeColumns() {
            const allColumnIds = [];
            gridApi.getColumns().forEach(column => {
                allColumnIds.push(column.getId());
            });
            gridApi.autoSizeColumns(allColumnIds, false);
        }

        // Quick stats function
        function getQuickStats() {
            if (!gridData || gridData.length === 0) {
                showStatusMessage('No data available for statistics', 'warning');
                return;
            }

            // Calculate statistics
            const stats = {
                totalRecords: gridData.length,
                totalExtendedPrice: 0,
                uniquePlans: new Set(),
                uniqueVendors: new Set(),
                uniqueCostCodes: new Set(),
                costCodeBreakdown: {},
                vendorBreakdown: {}
            };

            gridData.forEach(row => {
                if (row.extended_price) {
                    stats.totalExtendedPrice += parseFloat(row.extended_price);
                }
                if (row.plan_full_name) {
                    stats.uniquePlans.add(row.plan_full_name);
                }
                if (row.vendor_name) {
                    stats.uniqueVendors.add(row.vendor_name);
                    stats.vendorBreakdown[row.vendor_name] = (stats.vendorBreakdown[row.vendor_name] || 0) + parseFloat(row.extended_price || 0);
                }
                if (row.cost_code) {
                    stats.uniqueCostCodes.add(row.cost_code);
                    stats.costCodeBreakdown[row.cost_code] = (stats.costCodeBreakdown[row.cost_code] || 0) + parseFloat(row.extended_price || 0);
                }
            });

            // Display stats in modal
            const statsHtml = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Overview</h6>
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Total Records:</span>
                                <span class="fw-bold">${stats.totalRecords.toLocaleString()}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Total Extended Price:</span>
                                <span class="fw-bold text-success">$${stats.totalExtendedPrice.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Unique Plans:</span>
                                <span class="fw-bold">${stats.uniquePlans.size}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Unique Vendors:</span>
                                <span class="fw-bold">${stats.uniqueVendors.size}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Unique Cost Codes:</span>
                                <span class="fw-bold">${stats.uniqueCostCodes.size}</span>
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Top 5 Cost Codes by Value</h6>
                        <div class="small">
                            ${Object.entries(stats.costCodeBreakdown)
                                .sort((a, b) => b[1] - a[1])
                                .slice(0, 5)
                                .map(([code, value]) => 
                                    `<div class="d-flex justify-content-between mb-1">
                                        <span>${code}:</span>
                                        <span class="fw-bold">$${value.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                                    </div>`
                                ).join('')}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('statsContent').innerHTML = statsHtml;
            new bootstrap.Modal(document.getElementById('statsModal')).show();
        }

        // Build dependency mappings from data
        function buildDependencyMappings(data) {
            console.log('Building dependency mappings...');
            
            // Clear existing mappings
            dependencyMappings = {
                planToOptions: new Map(),
                costCodeToItems: new Map(),
                vendorToItems: new Map(),
                jobToCustomers: new Map(),
                allVendors: new Set(),
                allJobs: new Set(),
                allCustomers: new Set(),
                allCostCodes: new Set(),
                allItemNames: new Set()
            };
            
            data.forEach(row => {
                // Plan to Options mapping
                if (row.plan_full_name && row.option_name) {
                    if (!dependencyMappings.planToOptions.has(row.plan_full_name)) {
                        dependencyMappings.planToOptions.set(row.plan_full_name, new Set());
                    }
                    dependencyMappings.planToOptions.get(row.plan_full_name).add(row.option_name);
                }
                
                // Cost Code to Items mapping
                if (row.cost_code && row.item_name) {
                    if (!dependencyMappings.costCodeToItems.has(row.cost_code)) {
                        dependencyMappings.costCodeToItems.set(row.cost_code, new Set());
                    }
                    dependencyMappings.costCodeToItems.get(row.cost_code).add(row.item_name);
                }
                
                // Vendor to Items mapping
                if (row.vendor_name && row.item_name) {
                    if (!dependencyMappings.vendorToItems.has(row.vendor_name)) {
                        dependencyMappings.vendorToItems.set(row.vendor_name, new Set());
                    }
                    dependencyMappings.vendorToItems.get(row.vendor_name).add(row.item_name);
                }
                
                // Job to Customer mapping
                if (row.job_name && row.customer_name) {
                    if (!dependencyMappings.jobToCustomers.has(row.job_name)) {
                        dependencyMappings.jobToCustomers.set(row.job_name, new Set());
                    }
                    dependencyMappings.jobToCustomers.get(row.job_name).add(row.customer_name);
                }
                
                // Collect all unique values
                if (row.vendor_name) dependencyMappings.allVendors.add(row.vendor_name);
                if (row.job_name) dependencyMappings.allJobs.add(row.job_name);
                if (row.customer_name) dependencyMappings.allCustomers.add(row.customer_name);
                if (row.cost_code) dependencyMappings.allCostCodes.add(row.cost_code);
                if (row.item_name) dependencyMappings.allItemNames.add(row.item_name);
            });
            
            console.log('Dependency mappings built:', {
                planToOptions: dependencyMappings.planToOptions.size,
                costCodeToItems: dependencyMappings.costCodeToItems.size,
                vendorToItems: dependencyMappings.vendorToItems.size,
                jobToCustomers: dependencyMappings.jobToCustomers.size,
                totalVendors: dependencyMappings.allVendors.size,
                totalJobs: dependencyMappings.allJobs.size,
                totalCustomers: dependencyMappings.allCustomers.size,
                totalCostCodes: dependencyMappings.allCostCodes.size,
                totalItems: dependencyMappings.allItemNames.size
            });
        }

        // Get dependent options for plan selection
        function getOptionsForPlan(planName) {
            if (dependencyMappings.planToOptions.has(planName)) {
                return Array.from(dependencyMappings.planToOptions.get(planName)).sort();
            }
            return Array.from(dependencyMappings.allOptions || []).sort();
        }

        // Get dependent items for cost code
        function getItemsForCostCode(costCode) {
            if (dependencyMappings.costCodeToItems.has(costCode)) {
                return Array.from(dependencyMappings.costCodeToItems.get(costCode)).sort();
            }
            return Array.from(dependencyMappings.allItemNames).sort();
        }

        // Get dependent items for vendor
        function getItemsForVendor(vendorName) {
            if (dependencyMappings.vendorToItems.has(vendorName)) {
                return Array.from(dependencyMappings.vendorToItems.get(vendorName)).sort();
            }
            return Array.from(dependencyMappings.allItemNames).sort();
        }

        // Get dependent customers for job
        function getCustomersForJob(jobName) {
            if (dependencyMappings.jobToCustomers.has(jobName)) {
                return Array.from(dependencyMappings.jobToCustomers.get(jobName)).sort();
            }
            return Array.from(dependencyMappings.allCustomers).sort();
        }

        // Update row count display
        function updateRowCount() {
            const totalRows = gridApi.getDisplayedRowCount();
            const selectedRows = gridApi.getSelectedRows().length;
            const filteredRows = gridApi.getModel().getRowCount();
            
            document.getElementById('rowCount').textContent = totalRows;
            document.getElementById('selectedCount').textContent = selectedRows;
            document.getElementById('filteredCount').textContent = filteredRows;
        }

        // Duplicate selected rows function
        function duplicateSelectedRows() {
            const selectedRows = gridApi.getSelectedRows();
            
            if (selectedRows.length === 0) {
                showStatusMessage('Please select a row to duplicate', 'warning');
                return;
            }
            
            if (selectedRows.length > 1) {
                showStatusMessage('Please select only one row to duplicate', 'warning');
                return;
            }
            
            const originalRow = selectedRows[0];
            
            // Create a deep copy of the row
            const duplicatedRow = JSON.parse(JSON.stringify(originalRow));
            
            // Generate unique ID for the duplicated row (for frontend only)
            const duplicatedRowId = `duplicated_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            duplicatedRow.customRowId = duplicatedRowId;

            // Mark this row as duplicated for blue highlighting
            duplicatedRowIds.add(duplicatedRowId);

            // Send duplicated row to backend for insertion
            fetch('/api/comprehensive-takeoff-analysis/duplicate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(duplicatedRow)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Add duplicated row to the main grid data (not just the filtered view)
                    const originalRowIndex = gridData.findIndex(row => 
                        row.plan_full_name === originalRow.plan_full_name &&
                        row.option_name === originalRow.option_name &&
                        row.cost_code === originalRow.cost_code &&
                        row.item_name === originalRow.item_name &&
                        row.quantity === originalRow.quantity &&
                        row.unit_price === originalRow.unit_price
                    );
                    
                    if (originalRowIndex >= 0) {
                        // Insert duplicated row right after the original in the main data
                        gridData.splice(originalRowIndex + 1, 0, duplicatedRow);
                    } else {
                        // If we can't find the exact match, add to the end
                        gridData.push(duplicatedRow);
                    }
                    
                    // Add the duplicated row to the grid
                    gridApi.setRowData(gridData);
                    
                    showStatusMessage('Row duplicated and saved successfully - edit any field to remove blue highlighting', 'success');
                    console.log('Row duplicated and saved:', duplicatedRowId);
                } else {
                    showStatusMessage('Failed to save duplicated row: ' + (result.message || 'Unknown error'), 'danger');
                }
            })
            .catch(err => {
                showStatusMessage('Error saving duplicated row: ' + err, 'danger');
            });
        }

        // Delete selected row
        function deleteSelectedRow() {
            const selectedRows = gridApi.getSelectedRows();
            if (selectedRows.length === 0) {
                showStatusMessage('Please select a row to delete', 'warning');
                return;
            }
            if (selectedRows.length > 1) {
                showStatusMessage('Please select only one row to delete', 'warning');
                return;
            }
            const row = selectedRows[0];
            if (!confirm('Are you sure you want to delete this row? This action cannot be undone.')) {
                return;
            }
            // Send delete request to backend using takeoff_id
            fetch('/api/comprehensive-takeoff-analysis/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    takeoff_id: row.takeoff_id
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Remove from gridData and refresh grid
                    gridData = gridData.filter(r => r.takeoff_id !== row.takeoff_id);
                    gridApi.setRowData(gridData);
                    showStatusMessage('Row deleted successfully', 'success');
                } else {
                    showStatusMessage('Failed to delete row: ' + (result.message || 'Unknown error'), 'danger');
                }
            })
            .catch(err => {
                showStatusMessage('Error deleting row: ' + err, 'danger');
            });
        }

        // Handle cell value changes
        function onCellValueChanged(event) {
            const { data, colDef, newValue, oldValue } = event;
            
            // Remove blue highlighting if this is a duplicated row being edited
            if (data && data.customRowId && duplicatedRowIds.has(data.customRowId)) {
                duplicatedRowIds.delete(data.customRowId);
                // Refresh the row to remove blue styling
                gridApi.refreshRows({ rowNodes: [event.node] });
                console.log('Removed blue highlighting from edited duplicated row:', data.customRowId);
            }
            
            // Check if the change affects extended price calculation
            const pricingFields = ['quantity', 'unit_price', 'price_factor'];
            if (pricingFields.includes(colDef.field)) {
                // Force recalculation of extended price
                gridApi.refreshCells({
                    rowNodes: [event.node],
                    columns: ['extended_price'],
                    force: true
                });
                
                
                showStatusMessage(`Updated ${colDef.headerName}: ${oldValue} â†’ ${newValue}`, 'success');
            } else {
                showStatusMessage(`Updated ${colDef.headerName}`, 'success');
            }
            
            // Mark the row as modified (visual indicator)
            event.node.setRowHeight(undefined);
            
            console.log(`Cell changed: ${colDef.field} from "${oldValue}" to "${newValue}"`);
        }

        // Status message function
        function showStatusMessage(message, type) {
            const alertClass = `alert-${type}`;
            const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            const container = document.getElementById('statusMessages');
            container.innerHTML = alertHtml;
            
            // Auto-dismiss success messages
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    const alert = container.querySelector('.alert');
                    if (alert) {
                        const bsAlert = new bootstrap.Alert(alert);
                        bsAlert.close();
                    }
                }, 3000);
            }
        }

        // Toggle summary cards visibility
        function toggleSummary() {
            const summarySection = document.getElementById('summaryCardsSection');
            const toggleIcon = document.getElementById('summaryToggleIcon');
            const toggleText = document.getElementById('summaryToggleText');
            
            if (summarySection.style.display === 'none') {
                summarySection.style.display = 'block';
                toggleIcon.className = 'fas fa-chart-pie';
                toggleText.textContent = 'Hide Summary';
                updateSummaryCards();
            } else {
                summarySection.style.display = 'none';
                toggleIcon.className = 'fas fa-chart-pie';
                toggleText.textContent = 'Show Summary';
            }
        }

        // Update summary cards with current data (filtered data only)
        function updateSummaryCards() {
            if (!gridApi) return;

            let totalExtendedPrice = 0;
            let totalRecords = 0;
            const planOptionBreakdown = new Map();

            // Iterate through filtered data only (this ensures the cards respond to current filters)
            gridApi.forEachNodeAfterFilter((node) => {
                if (node.data) {
                    totalRecords++;
                    
                    // Calculate extended price
                    const quantity = parseFloat(node.data.quantity || 0);
                    const unitPrice = parseFloat(node.data.unit_price || 0);
                    const priceFactor = parseFloat(node.data.price_factor || 1);
                    const extendedPrice = quantity * unitPrice * priceFactor;
                    totalExtendedPrice += extendedPrice;
                    
                    // Build plan/option breakdown for filtered data only
                    const planName = node.data.plan_full_name || 'Unknown Plan';
                    const optionName = node.data.option_name || 'Unknown Option';
                    const key = `${planName} - ${optionName}`;
                    
                    if (!planOptionBreakdown.has(key)) {
                        planOptionBreakdown.set(key, {
                            planName: planName,
                            optionName: optionName,
                            totalPrice: 0,
                            recordCount: 0
                        });
                    }
                    
                    const breakdown = planOptionBreakdown.get(key);
                    breakdown.totalPrice += extendedPrice;
                    breakdown.recordCount += 1;
                }
            });

            // Update the header summary 
            document.getElementById('totalExtendedPrice').textContent = 
                '$' + totalExtendedPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('totalRecords').textContent = totalRecords.toLocaleString();

            // Build individual plan/option cards
            const cardsContainer = document.getElementById('planOptionCards');
            if (planOptionBreakdown.size === 0) {
                cardsContainer.innerHTML = '<div class="col-12"><p class="text-muted text-center">No data available - adjust your filters to see plan/option summaries</p></div>';
            } else {
                // Sort by total price descending
                const sortedBreakdown = Array.from(planOptionBreakdown.entries())
                    .sort((a, b) => b[1].totalPrice - a[1].totalPrice);

                // Create individual compact cards for each plan/option combination
                const cardsHtml = sortedBreakdown.map(([key, data]) => `
                    <div class="col-auto mb-1" style="min-width: 150px;">
                        <div class="card border-0 shadow-sm" style="height: auto;">
                            <div class="card-body" style="padding: 6px 8px;">
                                <div class="text-truncate" style="font-size: 13px; font-weight: bold; color: #007bff; line-height: 1.1; margin-bottom: 2px;" title="${data.planName}">
                                    ${data.planName.length > 18 ? data.planName.substring(0, 18) + '...' : data.planName}
                                </div>
                                <div style="margin-bottom: 3px;">
                                    <span class="badge bg-secondary" style="font-size: 10px; padding: 2px 4px;">${data.optionName}</span>
                                </div>
                                <div style="font-size: 14px; font-weight: bold; color: #28a745; line-height: 1.1; margin-bottom: 1px;">
                                    $${data.totalPrice.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0})}
                                </div>
                                <div style="font-size: 11px; color: #6c757d; line-height: 1;">
                                    ${data.recordCount} item${data.recordCount !== 1 ? 's' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                cardsContainer.innerHTML = cardsHtml;
            }
        }
    </script>
</body>
</html>
